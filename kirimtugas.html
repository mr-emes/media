<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TugasKu ‚Äî Sistem Pengumpulan Tugas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);min-height:100vh}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 30px rgba(2,6,23,.06);border:1px solid rgba(2,6,23,.06)}
    .btn{transition:.2s}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spin{width:1rem;height:1rem;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .drop{border:2px dashed #cbd5e1;border-radius:.75rem;padding:1.25rem;text-align:center;background:#f8fafc}
    .drop.drag{border-color:#3b82f6;background:#eff6ff}
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#eff6ff;color:#1d4ed8;font-weight:600;font-size:.75rem}
    dialog::backdrop{background:rgba(15,23,42,.45)}
    .table-wrap{overflow:auto;border:1px solid #e2e8f0;border-radius:.75rem}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.65rem .75rem;vertical-align:top}
    .table thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e2e8f0;text-align:left;font-weight:700}
    .table tbody tr+tr td{border-top:1px solid #f1f5f9}
    .qr{font-feature-settings:"tnum"; font-variant-numeric: tabular-nums;}
  </style>
</head>
<body class="text-slate-800">
  <header class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">TugasKu <span class="text-blue-600">MIN Singkawang</span></h1>
    <div class="flex items-center gap-3">
      <button id="goHomeBtn" class="hidden md:inline-flex btn px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Beranda</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- PILIH MODE -->
    <section id="modeSection" class="card p-6 md:p-10">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h2 class="text-2xl md:text-3xl font-bold mb-2">Pilih Mode</h2>
          <p class="text-slate-600">Masuk sebagai <span class="font-semibold">Siswa</span> untuk mengumpulkan tugas, atau <span class="font-semibold">Guru</span> untuk memeriksa dan memberi nilai.</p>
          <div class="mt-6 flex flex-wrap gap-3">
            <button id="studentModeBtn" class="btn px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700">üë®‚Äçüéì Mode Siswa</button>
            <button id="teacherModeBtn" class="btn px-5 py-3 rounded-lg bg-slate-700 text-white hover:bg-slate-800">üë©‚Äçüè´ Mode Guru</button>
          </div>
        </div>
        <div class="hidden md:block">
          <img src="https://illustrations.popsy.co/gray/student-studying.svg" alt="illustration" class="w-full max-w-md mx-auto">
        </div>
      </div>
    </section>

    <!-- SISWA: LOGIN NIS -->
    <section id="studentLoginSection" class="card p-6 md:p-8 mt-6 hidden">
      <div class="md:flex items-end gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">Masukkan NIS</label>
          <input id="nisInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Contoh: 20230123" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent qr">
        </div>
        <button id="nisSubmitBtn" class="btn px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Masuk Siswa</button>
        <button id="studentBackBtn" class="btn px-5 py-3 rounded-lg bg-slate-100 hover:bg-slate-200">Kembali</button>
      </div>
      <p class="text-slate-500 text-sm mt-3">Gunakan NIS yang terdaftar pada sheet <span class="font-semibold">SISWA</span>.</p>
    </section>

    <!-- SISWA: DASHBOARD -->
    <section id="studentSection" class="mt-6 hidden">
      <!-- Biodata -->
      <div class="card p-6 md:p-8">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 class="text-xl font-bold">Biodata Siswa</h3>
            <p class="text-slate-500">Data diambil dari sheet <span class="font-semibold">SISWA</span>.</p>
          </div>
          <span id="studentClassChip" class="chip"></span>
        </div>
        <div id="studentInfo" class="grid md:grid-cols-3 gap-4 mt-4 text-sm"></div>
      </div>

      <!-- Daftar Tugas -->
      <div class="card p-6 md:p-8 mt-6">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h3 class="text-xl font-bold">Daftar Tugas</h3>
            <p class="text-slate-500 text-sm">Hanya tugas untuk kelas siswa.</p>
          </div>
          <button id="refreshAssignmentsBtn" class="btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Muat Ulang</button>
        </div>
        <div id="assignmentsList" class="grid md:grid-cols-2 gap-4 mt-4"></div>
      </div>

      <!-- Form Pengumpulan -->
      <div class="card p-6 md:p-8 mt-6">
        <h3 class="text-xl font-bold">Kumpulkan Tugas</h3>
        <form id="assignmentForm" class="mt-4 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Pilih Tugas</label>
            <select id="assignmentSelect" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">‚Äî pilih tugas ‚Äî</option>
            </select>
          </div>
          <div id="dropZone" class="drop">
            <p id="dropZoneContent" class="text-slate-600">Seret & jatuhkan file ke sini, atau klik untuk memilih</p>
            <input id="fileInput" type="file" class="hidden" />
            <div id="fileInfo" class="hidden mt-3 text-sm">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-semibold" id="fileName"></div>
                  <div class="text-slate-500 text-xs" id="fileMeta"></div>
                </div>
                <button id="removeFileBtn" type="button" class="btn px-3 py-2 rounded-md bg-rose-50 text-rose-700 hover:bg-rose-100">Hapus</button>
              </div>
              <div id="filePreview" class="mt-3 text-xs text-slate-500"></div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="submitAssignmentBtn" class="btn px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700" type="submit">Kumpulkan</button>
            <span class="text-slate-500 text-sm">Pastikan tugas sudah benar sebelum mengirim.</span>
          </div>
        </form>
      </div>

      <!-- Riwayat Pengumpulan -->
      <div class="card p-6 md:p-8 mt-6">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">Riwayat Pengumpulan</h3>
          <button id="refreshStudentSubmissionsBtn" class="btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Muat Ulang</button>
        </div>
        <div class="table-wrap mt-4">
          <table class="table text-sm">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Mapel</th>
                <th>Tugas</th>
                <th>File</th>
                <th>Status</th>
                <th>Nilai</th>
                <th>Feedback</th>
              </tr>
            </thead>
            <tbody id="studentSubmissionsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GURU: LOGIN -->
    <section id="teacherLoginSection" class="card p-6 md:p-8 mt-6 hidden">
      <h3 class="text-xl font-bold mb-4">üîê Login Guru</h3>
      <div class="md:flex items-end gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">Password Guru</label>
          <input id="teacherPasswordInput" type="password" placeholder="Masukkan password" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button id="teacherLoginBtn" class="btn px-5 py-3 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Masuk Guru</button>
        <button id="teacherBackBtn" class="btn px-5 py-3 rounded-lg bg-slate-100 hover:bg-slate-200">Kembali</button>
      </div>
      <p class="text-slate-500 text-sm mt-3">Setelah login, Anda dapat menilai tugas siswa.</p>
    </section>

    <!-- GURU: PANEL -->
    <section id="teacherSection" class="mt-6 hidden">
      <div class="card p-6 md:p-8">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h3 class="text-xl font-bold">Panel Guru</h3>
            <p class="text-slate-500 text-sm">Filter dan nilai pengumpulan tugas.</p>
          </div>
          <div class="flex gap-2">
            <button id="reloadFiltersBtn" class="btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Muat Data</button>
            <button id="reloadTeacherListBtn" class="btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Muat Ulang Daftar</button>
          </div>
        </div>

        <div class="grid md:grid-cols-4 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium mb-1">Kelas</label>
            <select id="filterClass" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Semua</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Mapel</label>
            <select id="filterSubject" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Semua</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Tugas</label>
            <input id="filterTask" type="text" placeholder="Judul Tugas (opsional)" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="flex items-end">
            <button id="applyFilterBtn" class="btn w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Terapkan Filter</button>
          </div>
        </div>

        <div class="table-wrap mt-6">
          <table class="table text-sm">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>NIS</th>
                <th>Nama</th>
                <th>Kelas</th>
                <th>Mapel</th>
                <th>Tugas</th>
                <th>File</th>
                <th>Status</th>
                <th>Nilai</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="teacherSubmissionsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: Sukses -->
  <dialog id="successDialog" class="p-0 rounded-2xl w-full max-w-md">
    <div class="p-6">
      <h4 class="text-lg font-bold">‚úÖ Berhasil</h4>
      <p id="successDialogMsg" class="text-slate-600 mt-2">Tugas berhasil dikirim.</p>
      <div class="mt-5 flex justify-end gap-2">
        <button class="btn px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" onclick="document.getElementById('successDialog').close()">Tutup</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL: Penilaian -->
  <dialog id="gradeDialog" class="p-0 rounded-2xl w-full max-w-md">
    <form id="gradeForm" class="p-6 space-y-3">
      <h4 class="text-lg font-bold">üìù Penilaian</h4>
      <p id="gradeMeta" class="text-slate-600 text-sm"></p>
      <div>
        <label class="block text-sm font-medium mb-1">Nilai</label>
        <input id="gradeScore" type="number" step="1" min="0" max="100" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Feedback (opsional)</label>
        <textarea id="gradeFeedback" rows="3" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" class="btn px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200" onclick="document.getElementById('gradeDialog').close()">Batal</button>
        <button id="gradeSaveBtn" class="btn px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" type="submit">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- TOAST -->
  <div id="toast" class="fixed top-4 right-4 hidden px-4 py-2 rounded-lg text-white shadow-lg"></div>

  <script>
    // ==========================
    // KONFIGURASI CLIENT
    // ==========================
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwhq9UYVTVcWkAX-F3zaxkzh2qPjVyW4i9ljsqcDTv61L2CvNsG6whY9TZPWNihXr-b/exec';

    // ==========================
    // STATE
    // ==========================
    let currentStudent = null;    // {NIS,NAMA,KELAS,...}
    let currentAssignments = [];  // array tugas utk kelas
    let teacherLoggedIn = false;
    let gradeTarget = null;       // record yang sedang dinilai

    // ==========================
    // ELEMEN
    // ==========================
    const modeSection = document.getElementById('modeSection');
    const goHomeBtn = document.getElementById('goHomeBtn');

    // student login & section
    const studentLoginSection = document.getElementById('studentLoginSection');
    const nisInput = document.getElementById('nisInput');
    const nisSubmitBtn = document.getElementById('nisSubmitBtn');
    const studentBackBtn = document.getElementById('studentBackBtn');

    const studentSection = document.getElementById('studentSection');
    const studentInfo = document.getElementById('studentInfo');
    const studentClassChip = document.getElementById('studentClassChip');

    // assignments
    const refreshAssignmentsBtn = document.getElementById('refreshAssignmentsBtn');
    const assignmentsList = document.getElementById('assignmentsList');
    const assignmentForm = document.getElementById('assignmentForm');
    const assignmentSelect = document.getElementById('assignmentSelect');

    // file input / drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropZoneContent = document.getElementById('dropZoneContent');
    const fileInfo = document.getElementById('fileInfo');
    const fileNameEl = document.getElementById('fileName');
    const fileMetaEl = document.getElementById('fileMeta');
    const filePreview = document.getElementById('filePreview');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const submitAssignmentBtn = document.getElementById('submitAssignmentBtn');

    // student submissions
    const refreshStudentSubmissionsBtn = document.getElementById('refreshStudentSubmissionsBtn');
    const studentSubmissionsTbody = document.getElementById('studentSubmissionsTbody');

    // teacher
    const teacherModeBtn = document.getElementById('teacherModeBtn');
    const studentModeBtn = document.getElementById('studentModeBtn');
    const teacherLoginSection = document.getElementById('teacherLoginSection');
    const teacherBackBtn = document.getElementById('teacherBackBtn');
    const teacherPasswordInput = document.getElementById('teacherPasswordInput');
    const teacherLoginBtn = document.getElementById('teacherLoginBtn');
    const teacherSection = document.getElementById('teacherSection');
    const reloadFiltersBtn = document.getElementById('reloadFiltersBtn');
    const reloadTeacherListBtn = document.getElementById('reloadTeacherListBtn');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const filterClass = document.getElementById('filterClass');
    const filterSubject = document.getElementById('filterSubject');
    const filterTask = document.getElementById('filterTask');
    const teacherSubmissionsTbody = document.getElementById('teacherSubmissionsTbody');

    // modal
    const successDialog = document.getElementById('successDialog');
    const successDialogMsg = document.getElementById('successDialogMsg');
    const gradeDialog = document.getElementById('gradeDialog');
    const gradeForm = document.getElementById('gradeForm');
    const gradeMeta = document.getElementById('gradeMeta');
    const gradeScore = document.getElementById('gradeScore');
    const gradeFeedback = document.getElementById('gradeFeedback');
    const gradeSaveBtn = document.getElementById('gradeSaveBtn');

    // toast
    const toast = document.getElementById('toast');

    // ==========================
    // UTIL
    // ==========================
    function showToast(msg, type='info'){
      toast.textContent = msg;
      toast.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-white shadow-lg';
      toast.classList.add(type==='error'?'bg-rose-600': type==='success'?'bg-emerald-600':'bg-slate-900');
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 2600);
    }

    function formatDate(v){
      try{
        const d = (v instanceof Date)? v : new Date(v);
        if (Number.isNaN(d.getTime())) return '-';
        return d.toLocaleString('id-ID',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      }catch{ return '-'; }
    }

    function clearChildren(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    function fileIconByType(type=''){
      if(type.includes('pdf')) return 'üìÑ';
      if(type.includes('image')) return 'üñºÔ∏è';
      if(type.includes('video')) return 'üéûÔ∏è';
      if(type.includes('audio')) return 'üéµ';
      if(type.includes('sheet')||type.includes('excel')) return 'üìä';
      if(type.includes('presentation')||type.includes('powerpoint')) return 'üìΩÔ∏è';
      return 'üóÇÔ∏è';
    }

    async function readFileAsBase64(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = () => {
          const base64 = String(r.result).split(',')[1] || '';
          res(base64);
        };
        r.onerror = () => rej(r.error||new Error('Gagal membaca file'));
        r.readAsDataURL(file);
      });
    }

    function setSection(id){
      // sembunyikan semua
      [modeSection, studentLoginSection, studentSection, teacherLoginSection, teacherSection].forEach(s=>s.classList.add('hidden'));
      // tampilkan
      document.getElementById(id).classList.remove('hidden');
      // tombol beranda
      goHomeBtn.classList.toggle('hidden', id==='modeSection');
    }

    function buildKV(label, value){
      const div = document.createElement('div');
      div.className = 'p-4 rounded-lg border border-slate-200 bg-slate-50';
      div.innerHTML = `<div class="text-xs text-slate-500">${label}</div><div class="font-semibold">${value??'-'}</div>`;
      return div;
    }

    function opt(v,t){ const o=document.createElement('option'); o.value=v; o.textContent=t; return o; }

    // ==========================
    // EVENT: NAVIGASI
    // ==========================
    goHomeBtn.addEventListener('click', ()=> setSection('modeSection'));
    studentModeBtn.addEventListener('click', ()=> setSection('studentLoginSection'));
    teacherModeBtn.addEventListener('click', ()=> setSection('teacherLoginSection'));
    studentBackBtn.addEventListener('click', ()=> setSection('modeSection'));
    teacherBackBtn.addEventListener('click', ()=> setSection('modeSection'));

    // ==========================
    // SISWA: LOGIN NIS
    // ==========================
    nisSubmitBtn.addEventListener('click', async()=>{
      const nis = (nisInput.value||'').trim();
      if(!nis){ showToast('NIS wajib diisi','error'); return; }
      nisSubmitBtn.disabled = true; nisSubmitBtn.innerHTML = '<span class="spin inline-block mr-2"></span>Memeriksa...';
      try{
        const response = await fetch(`${WEB_APP_URL}?action=getStudentData&nis=${encodeURIComponent(nis)}`);
        const json = await response.json();
        if(!json || json.error || json.success===false){ throw new Error(json?.error||'Siswa tidak ditemukan'); }
        currentStudent = json.data;
        // tampil
        setSection('studentSection');
        // biodata
        clearChildren(studentInfo);
        studentInfo.appendChild(buildKV('NIS', currentStudent.NIS));
        studentInfo.appendChild(buildKV('Nama', currentStudent.NAMA));
        studentInfo.appendChild(buildKV('Kelas', currentStudent.KELAS));
        studentInfo.appendChild(buildKV('Email', currentStudent.EMAIL||'-'));
        studentInfo.appendChild(buildKV('Jenis Kelamin', currentStudent.JENIS_KELAMIN||'-'));
        studentInfo.appendChild(buildKV('Tanggal Lahir', currentStudent.TANGGAL_LAHIR||'-'));
        studentClassChip.textContent = `Kelas ${currentStudent.KELAS}`;
        // muat tugas & pengumpulan siswa
        await Promise.all([loadAssignments(), loadStudentSubmissions()]);
      }catch(err){
        console.error(err);
        showToast(err.message||'Gagal memuat data siswa','error');
      }finally{
        nisSubmitBtn.disabled = false; nisSubmitBtn.textContent = 'Masuk Siswa';
      }
    });

    // ==========================
    // SISWA: LIST TUGAS
    // ==========================
    async function loadAssignments(){
      if(!currentStudent) return;
      refreshAssignmentsBtn.disabled=true;
      try{
        const response = await fetch(`${WEB_APP_URL}?action=getAssignments&kelas=${encodeURIComponent(currentStudent.KELAS)}`);
        const json = await response.json();
        currentAssignments = json?.data||[];
        // render pilihan select
        clearChildren(assignmentSelect);
        assignmentSelect.appendChild(opt('','‚Äî pilih tugas ‚Äî'));
        currentAssignments.forEach(a=>{
          assignmentSelect.appendChild(opt(JSON.stringify(a), `${a.MAPEL} ‚Äî ${a.TUGAS}`));
        });
        // render kartu tugas
        clearChildren(assignmentsList);
        if(!currentAssignments.length){
          assignmentsList.innerHTML = `<div class="text-slate-500">Belum ada tugas untuk kelas ${currentStudent.KELAS}.</div>`;
        }else{
          currentAssignments.forEach(a=>{
            const card = document.createElement('div');
            card.className = 'p-4 rounded-lg border border-slate-200 bg-white';
            card.innerHTML = `
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="font-bold">${a.TUGAS}</div>
                  <div class="text-slate-600 text-sm">${a.MAPEL} ‚Ä¢ Kelas ${a.KELAS}</div>
                </div>
                <span class="chip">${a.STATUS||'Aktif'}</span>
              </div>
              <div class="mt-2 text-sm text-slate-600">${a.DETAIL_TUGAS||''}</div>
              <div class="mt-2 text-xs text-slate-500">Tanggal: ${a.TANGGAL||'-'} | Deadline: ${a.DEADLINE||'-'}</div>
              <div class="mt-3">
                <button class="btn px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 selectForUpload">Pilih untuk dikumpulkan</button>
              </div>`;
            card.querySelector('.selectForUpload').addEventListener('click',()=>{
              assignmentSelect.value = JSON.stringify(a);
              assignmentSelect.dispatchEvent(new Event('change'));
              window.scrollTo({top: assignmentForm.offsetTop-80, behavior:'smooth'});
            });
            assignmentsList.appendChild(card);
          });
        }
      }catch(e){
        console.error(e); showToast('Gagal memuat daftar tugas','error');
      }finally{ refreshAssignmentsBtn.disabled=false; }
    }
    refreshAssignmentsBtn.addEventListener('click', loadAssignments);

    // ==========================
    // SISWA: DROPZONE
    // ==========================
    function openPicker(){ fileInput.click(); }
    dropZone.addEventListener('click', openPicker);
    dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('drag'); });
    dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('drag'));
    dropZone.addEventListener('drop', (e)=>{
      e.preventDefault();
      dropZone.classList.remove('drag');
      if(e.dataTransfer.files && e.dataTransfer.files[0]){
        fileInput.files = e.dataTransfer.files;
        updateFileUI();
      }
    });
    fileInput.addEventListener('change', updateFileUI);
    removeFileBtn.addEventListener('click', ()=>{
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      dropZoneContent.classList.remove('hidden');
    });

    function updateFileUI(){
      const file = fileInput.files?.[0];
      if(!file){ return; }
      fileNameEl.textContent = `${fileIconByType(file.type)} ${file.name}`;
      fileMetaEl.textContent = `${(file.size/1024/1024).toFixed(2)} MB ‚Ä¢ ${file.type||'unknown'}`;
      filePreview.textContent = (file.type||'').includes('image') ? 'Preview: (gambar akan dikirim penuh saat submit)' : 'File siap dikirim.';
      dropZoneContent.classList.add('hidden');
      fileInfo.classList.remove('hidden');
    }

    // ==========================
    // SISWA: KIRIM TUGAS
    // ==========================
    assignmentForm.addEventListener('submit', async(e)=>{
      e.preventDefault();
      if(!currentStudent){ showToast('Login siswa dulu','error'); return; }
      const aStr = assignmentSelect.value;
      if(!aStr){ showToast('Pilih tugas terlebih dahulu','error'); return; }
      const a = JSON.parse(aStr);
      const file = fileInput.files?.[0];
      if(!file){ showToast('Pilih file tugas terlebih dahulu','error'); return; }

      submitAssignmentBtn.disabled = true; submitAssignmentBtn.innerHTML = '<span class="spin inline-block mr-2"></span>Mengirim...';
      try{
        const base64 = await readFileAsBase64(file);
        const payload = {
          action: 'submitAssignment',
          nis: currentStudent.NIS,
          nama: currentStudent.NAMA,
          kelas: currentStudent.KELAS,
          mapel: a.MAPEL,
          tugas: a.TUGAS,
          file: { name: file.name, type: file.type || 'application/octet-stream', data: base64 }
        };
        const response = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await response.json();
        if(!response.ok || json?.success!==true){
          throw new Error(json?.error || 'Gagal mengirim tugas');
        }
        successDialogMsg.textContent = 'Tugas berhasil dikirim. Cek status pada daftar pengumpulan.';
        successDialog.showModal();
        // reset form
        fileInput.value = '';
        fileInfo.classList.add('hidden'); dropZoneContent.classList.remove('hidden');
        assignmentSelect.value = '';
        // refresh riwayat
        await loadStudentSubmissions();
      }catch(err){
        console.error(err); showToast(err.message||'Gagal mengirim tugas','error');
      }finally{
        submitAssignmentBtn.disabled = false; submitAssignmentBtn.textContent = 'Kumpulkan';
      }
    });

    async function loadStudentSubmissions(){
      if(!currentStudent) return;
      try{
        const response = await fetch(`${WEB_APP_URL}?action=getSubmissions&nis=${encodeURIComponent(currentStudent.NIS)}`);
        const json = await response.json();
        const rows = json?.data||[];
        clearChildren(studentSubmissionsTbody);
        if(!rows.length){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="7" class="text-center text-slate-500 py-6">Belum ada pengumpulan.</td>`;
          studentSubmissionsTbody.appendChild(tr);
          return;
        }
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="whitespace-nowrap">${formatDate(r.TIMESTAMP||r.TANGGAL_UPLOAD)}</td>
            <td>${r.MAPEL||'-'}</td>
            <td>${r.TUGAS||'-'}</td>
            <td><a class="text-blue-600 hover:underline" href="${r.FILE_URL}" target="_blank" rel="noopener">Buka File</a></td>
            <td><span class="chip ${r.STATUS==='Dinilai'?'bg-emerald-50 text-emerald-700':'bg-amber-50 text-amber-700'}">${r.STATUS||'Pending'}</span></td>
            <td>${(r.NILAI??'')===''?'-':r.NILAI}</td>
            <td>${r.FEEDBACK||'-'}</td>`;
          studentSubmissionsTbody.appendChild(tr);
        });
      }catch(err){
        console.error(err); showToast('Gagal memuat pengumpulan','error');
      }
    }
    refreshStudentSubmissionsBtn.addEventListener('click', loadStudentSubmissions);

    // ==========================
    // GURU: LOGIN
    // ==========================
    teacherLoginBtn.addEventListener('click', async()=>{
      const pass = (teacherPasswordInput.value||'').trim();
      if(!pass){ showToast('Password wajib diisi','error'); return; }
      teacherLoginBtn.disabled = true; teacherLoginBtn.innerHTML = '<span class="spin inline-block mr-2"></span>Memeriksa...';
      try{
        // kirim ke Apps Script
        const response = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'teacherLogin', password: pass })
        });
        const json = await response.json();
        if(!response.ok || json?.success!==true){ throw new Error(json?.error||'Login gagal'); }
        teacherLoggedIn = true;
        setSection('teacherSection');
        await loadFilters();
        await loadTeacherSubmissions();
      }catch(err){
        console.error(err); showToast(err.message||'Login gagal','error');
      }finally{
        teacherLoginBtn.disabled = false; teacherLoginBtn.textContent = 'Masuk Guru';
      }
    });

    // ==========================
    // GURU: FILTER & LIST
    // ==========================
    async function loadFilters(){
      try{
        const response = await fetch(`${WEB_APP_URL}?action=getInitialData`);
        const json = await response.json();
        const classes = json?.data?.classes||[];
        const subjects = json?.data?.subjects||[];
        clearChildren(filterClass);
        clearChildren(filterSubject);
        filterClass.appendChild(opt('','Semua'));
        filterSubject.appendChild(opt('','Semua'));
        classes.forEach(c=> filterClass.appendChild(opt(c, c)));
        subjects.forEach(s=> filterSubject.appendChild(opt(s, s)));
      }catch(e){
        console.error(e); showToast('Gagal memuat data filter','error');
      }
    }
    reloadFiltersBtn.addEventListener('click', loadFilters);
    reloadTeacherListBtn.addEventListener('click', loadTeacherSubmissions);
    applyFilterBtn.addEventListener('click', loadTeacherSubmissions);

    async function loadTeacherSubmissions(){
      try{
        teacherSubmissionsTbody.innerHTML = `<tr><td colspan="10" class="py-6 text-center text-slate-500">Memuat...</td></tr>`;
        const params = new URLSearchParams({ action:'getSubmissions' });
        if(filterClass.value) params.set('kelas', filterClass.value);
        if(filterSubject.value) params.set('mapel', filterSubject.value);
        if(filterTask.value.trim()) params.set('tugas', filterTask.value.trim());
        const url = `${WEB_APP_URL}?${params.toString()}`;
        const response = await fetch(url);
        const json = await response.json();
        const rows = json?.data||[];
        clearChildren(teacherSubmissionsTbody);
        if(!rows.length){
          teacherSubmissionsTbody.innerHTML = `<tr><td colspan="10" class="py-6 text-center text-slate-500">Tidak ada data.</td></tr>`;
          return;
        }
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="whitespace-nowrap">${formatDate(r.TIMESTAMP||r.TANGGAL_UPLOAD)}</td>
            <td class="qr">${r.NIS||'-'}</td>
            <td>${r.NAMA||'-'}</td>
            <td>${r.KELAS||'-'}</td>
            <td>${r.MAPEL||'-'}</td>
            <td>${r.TUGAS||'-'}</td>
            <td><a class="text-blue-600 hover:underline" href="${r.FILE_URL}" target="_blank" rel="noopener">Buka</a></td>
            <td><span class="chip ${r.STATUS==='Dinilai'?'bg-emerald-50 text-emerald-700':'bg-amber-50 text-amber-700'}">${r.STATUS||'Pending'}</span></td>
            <td>${(r.NILAI??'')===''?'-':r.NILAI}</td>
            <td>
              <button class="btn px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 gradeBtn">Nilai</button>
            </td>`;
          const btn = tr.querySelector('.gradeBtn');
          btn.addEventListener('click', ()=>{
            gradeTarget = r;
            gradeMeta.textContent = `${r.NAMA||'-'} ‚Ä¢ ${r.NIS||'-'} ‚Ä¢ ${r.KELAS||'-'} | ${r.MAPEL||'-'} ‚Äî ${r.TUGAS||'-'}`;
            gradeScore.value = (r.NILAI??'')===''?'' : r.NILAI;
            gradeFeedback.value = r.FEEDBACK||'';
            gradeDialog.showModal();
            gradeScore.focus();
          });
          teacherSubmissionsTbody.appendChild(tr);
        });
      }catch(err){
        console.error(err); showToast('Gagal memuat daftar pengumpulan','error');
      }
    }

    // ==========================
    // GURU: SIMPAN NILAI
    // ==========================
    gradeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!gradeTarget){ gradeDialog.close(); return; }
      const nilai = Number(gradeScore.value);
      if(Number.isNaN(nilai)){ showToast('Nilai tidak valid','error'); return; }
      gradeSaveBtn.disabled = true; gradeSaveBtn.innerHTML = '<span class="spin inline-block mr-2"></span>Menyimpan...';
      try{
        const payload = {
          action:'saveGrade',
          nis: gradeTarget.NIS,
          mapel: gradeTarget.MAPEL,
          tugas: gradeTarget.TUGAS,
          nilai: nilai,
          feedback: gradeFeedback.value||''
        };
        const response = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await response.json();
        if(!response.ok || json?.success!==true){
          throw new Error(json?.error||'Gagal menyimpan nilai');
        }
        gradeDialog.close();
        showToast('Nilai berhasil disimpan','success');
        await loadTeacherSubmissions();
      }catch(err){
        console.error(err); showToast(err.message||'Gagal menyimpan nilai','error');
      }finally{
        gradeSaveBtn.disabled = false; gradeSaveBtn.textContent = 'Simpan';
      }
    });

    // ==========================
    // START
    // ==========================
    // tombol mode
    document.getElementById('studentModeBtn').addEventListener('click', ()=> setSection('studentLoginSection'));
    document.getElementById('teacherModeBtn').addEventListener('click', ()=> setSection('teacherLoginSection'));
    // default
    setSection('modeSection');
  </script>
</body>
</html>
