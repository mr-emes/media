// Konfigurasi
const SPREADSHEET_ID = '1-CcM4_RQrBmivFtABScmq1PmqlXEgTEfYbtRSAt8BaU';
const DRIVE_FOLDER_ID = '19_gDP_ePMBtgv3QRjt76Uzdp82xz5k7U';

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  // Set CORS headers
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };

  // Handle CORS preflight
  if (e.queryString === 'cors' || e.parameter.cors) {
    return HtmlService.createHtmlOutput(JSON.stringify({success: true}))
      .setHeaders(headers);
  }

  try {
    let params = e.parameter || {};
    let postData = {};
    
    // Parse POST data if available
    if (e.postData && e.postData.contents) {
      try {
        postData = JSON.parse(e.postData.contents);
      } catch (err) {
        // Handle multipart/form-data
        const contentType = e.postData.type;
        if (contentType.includes('multipart/form-data')) {
          const boundary = contentType.split('boundary=')[1];
          const parts = e.postData.contents.split('--' + boundary);
          
          // Process each part
          parts.forEach(part => {
            if (part.includes('Content-Disposition: form-data')) {
              const nameMatch = part.match(/name="([^"]+)"/);
              if (nameMatch) {
                const name = nameMatch[1];
                const value = part.split('\r\n\r\n')[1].trim();
                postData[name] = value;
              }
              
              // Handle file upload
              const filenameMatch = part.match(/filename="([^"]+)"/);
              if (filenameMatch) {
                const filename = filenameMatch[1];
                const fileContent = part.split('\r\n\r\n')[1];
                postData.file = fileContent;
                postData.fileName = filename;
                
                // Get content type if available
                const contentTypeMatch = part.match(/Content-Type: ([^\r\n]+)/);
                if (contentTypeMatch) {
                  postData.fileType = contentTypeMatch[1];
                }
              }
            }
          });
        } else {
          postData = e.parameter;
        }
      }
    }

    const action = params.action || postData.action;
    const output = ContentService.createTextOutput();
    
    switch(action) {
      case 'getStudentData':
        const nis = params.nis || postData.nis;
        output.setContent(JSON.stringify(getStudentData(nis)));
        break;
      case 'getAssignments':
        const kelas = params.kelas || postData.kelas;
        output.setContent(JSON.stringify(getAssignments(kelas)));
        break;
      case 'submitAssignment':
        output.setContent(JSON.stringify(handleSubmission(params, postData)));
        break;
      case 'getSubmissions':
        const filters = params.filters || postData.filters || {};
        output.setContent(JSON.stringify(getSubmissions(filters)));
        break;
      case 'saveGrade':
        output.setContent(JSON.stringify(saveGrade(params, postData)));
        break;
      default:
        output.setContent(JSON.stringify({
          success: false,
          message: 'Aksi tidak valid'
        }));
    }
    
    output.setMimeType(ContentService.MimeType.JSON)
          .setHeaders(headers);
    return output;
    
  } catch (error) {
    console.error('Error:', error);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: error.toString(),
      stack: error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getStudentData(nis) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('SISWA');
  const data = sheet.getDataRange().getValues();
  
  // Header: [NIS, NAMA, KELAS]
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == nis) {
      return {
        success: true,
        data: {
          NIS: data[i][0],
          NAMA: data[i][1],
          KELAS: data[i][2]
        }
      };
    }
  }
  
  return {
    success: false,
    message: 'NIS tidak ditemukan'
  };
}

function getAssignments(kelas) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('TUGAS');
  const data = sheet.getDataRange().getValues();
  const assignments = [];
  
  // Header: [MAPEL, KELAS, TUGAS, DETAIL_TUGAS, TANGGAL]
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] == kelas) {
      assignments.push({
        MAPEL: data[i][0],
        KELAS: data[i][1],
        TUGAS: data[i][2],
        DETAIL_TUGAS: data[i][3],
        TANGGAL: Utilities.formatDate(new Date(data[i][4]), Session.getScriptTimeZone(), 'dd/MM/yyyy')
      });
    }
  }
  
  return {
    success: true,
    data: assignments
  };
}

function getSubmissions(filters = {}) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('NILAI');
  const data = sheet.getDataRange().getValues();
  const submissions = [];
  
  // Header: [TIMESTAMP, TUGAS, MAPEL, KELAS, NIS, NAMA, NILAI, FILE_NAME, FILE_TYPE, FILE_URL, FEEDBACK]
  for (let i = 1; i < data.length; i++) {
    // Apply filters
    let match = true;
    
    if (filters.nis && data[i][4] != filters.nis) match = false;
    if (filters.kelas && data[i][3] != filters.kelas) match = false;
    if (filters.mapel && data[i][2] != filters.mapel) match = false;
    
    if (match) {
      submissions.push({
        TIMESTAMP: Utilities.formatDate(new Date(data[i][0]), Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm'),
        TUGAS: data[i][1],
        MAPEL: data[i][2],
        KELAS: data[i][3],
        NIS: data[i][4],
        NAMA: data[i][5],
        NILAI: data[i][6],
        FILE_NAME: data[i][7],
        FILE_TYPE: data[i][8],
        FILE_URL: data[i][9],
        FEEDBACK: data[i][10]
      });
    }
  }
  
  return {
    success: true,
    data: submissions
  };
}

function handleSubmission(params, postData) {
  try {
    const data = Object.assign({}, params, postData);
    
    // Validasi data wajib
    if (!data.tugas || !data.mapel || !data.kelas || !data.nis || !data.nama) {
      throw new Error('Data tugas tidak lengkap');
    }
    
    // Handle file upload
    if (data.fileData) {
      return submitAssignment(data);
    } else if (data.file) {
      // Handle FormData upload
      const fileBlob = Utilities.newBlob(
        data.file,
        data.fileType || 'application/octet-stream',
        data.fileName || 'tugas_' + data.nis + '_' + new Date().getTime()
      );
      data.fileBlob = fileBlob;
      return submitAssignment(data);
    } else {
      throw new Error('File tugas tidak ditemukan');
    }
  } catch (error) {
    console.error('Submission error:', error);
    return {
      success: false,
      message: error.toString(),
      stack: error.stack
    };
  }
}

function submitAssignment(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('NILAI');
  
  try {
    let fileUrl = '';
    let fileName = data.fileName || '';
    let fileType = data.fileType || '';
    
    // Upload file to Drive
    if (data.fileBlob || data.fileData) {
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      let file;
      
      if (data.fileBlob) {
        file = folder.createFile(data.fileBlob);
      } else {
        file = folder.createFile(Utilities.newBlob(
          Utilities.base64Decode(data.fileData),
          data.fileType || 'application/octet-stream',
          data.fileName || 'tugas_' + data.nis + '_' + new Date().getTime()
        ));
      }
      
      fileUrl = file.getUrl();
      fileName = file.getName();
      fileType = file.getMimeType();
    }
    
    // Format: [Timestamp, Tugas, Mapel, Kelas, NIS, Nama, Nilai, FileName, FileType, FileUrl, Feedback]
    sheet.appendRow([
      new Date(),
      data.tugas,
      data.mapel,
      data.kelas,
      data.nis,
      data.nama,
      '', // Nilai kosong
      fileName,
      fileType,
      fileUrl,
      '' // Feedback kosong
    ]);
    
    return {
      success: true,
      message: 'Tugas berhasil dikumpulkan',
      fileUrl: fileUrl
    };
  } catch (error) {
    console.error('Error submitting assignment:', error);
    return {
      success: false,
      message: 'Gagal menyimpan tugas: ' + error.toString(),
      stack: error.stack
    };
  }
}

function saveGrade(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('NILAI');
  const rows = sheet.getDataRange().getValues();
  
  try {
    // Validasi input
    if (!data.nis || !data.tugas || !data.mapel || !data.nilai) {
      throw new Error('Data nilai tidak lengkap');
    }
    
    // Cari baris yang sesuai
    let rowIndex = -1;
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][4] == data.nis && rows[i][1] == data.tugas && rows[i][2] == data.mapel) {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) {
      throw new Error('Data tugas tidak ditemukan');
    }
    
    // Update nilai dan feedback
    sheet.getRange(rowIndex + 1, 7).setValue(data.nilai); // Kolom Nilai
    sheet.getRange(rowIndex + 1, 11).setValue(data.feedback || ''); // Kolom Feedback
    
    return {
      success: true,
      message: 'Nilai berhasil disimpan'
    };
  } catch (error) {
    console.error('Error saving grade:', error);
    return {
      success: false,
      message: 'Gagal menyimpan nilai: ' + error.toString(),
      stack: error.stack
    };
  }
}
